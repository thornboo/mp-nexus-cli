# 测试策略

**实现状态**：✅ **基础完成，单元测试已实现**

## 测试金字塔架构

### 单元测试（基础层）✅ **已实现**
- ✅ **i18n 系统**（16 个测试）：语言支持、检测、翻译、参数替换
- ✅ **错误处理**（14 个测试）：错误创建、分类、退出码、字符串错误处理
- ✅ **日志系统**（17 个测试）：日志级别、i18n 集成、调试模式、消息格式化
- ⚠️ **配置解析**：环境优先级、配置合并逻辑 *(待实现)*
- ⚠️ **重试机制**：网络和构建操作重试 *(待实现)*
- ⚠️ **Git 集成**：提交消息和版本提取 *(待实现)*

### 组件测试（集成层）
- **框架适配器**：使用模拟 CLI 调用测试 `detect()`、`build()`、`getOutputPath()` 方法
- **平台适配器**：使用模拟 miniprogram-ci 测试预览/上传操作
- **配置系统**：多环境配置加载和优先级解析
- **错误分类**：正确的错误代码分配和消息生成

### 集成测试（端到端层）
- **完整工作流**：使用模拟平台适配器的完整 `preview`/`deploy` 操作
- **CLI 界面**：命令解析和参数验证
- **跨平台兼容性**：Windows/macOS/Linux 路径和子进程处理

## 模拟和测试夹具

### 平台适配器模拟 ✅ 就绪
- **微信模拟**：使用内置模拟适配器（`createWeappAdapter`）获得可预测的结果
- **二维码生成**：模拟二维码文件创建和终端输出
- **上传结果**：模拟成功和失败的上传场景

### 外部服务模拟
- **通知系统**：使用 `mock://...` webhook URL 跳过真实网络请求
- **Git 操作**：模拟 `simple-git` 或提供示例仓库夹具
- **框架 CLI**：模拟 Taro/uni-app CLI 调用以避免真实构建依赖

### 测试数据夹具
- **示例项目**：最小的 Taro 和 uni-app 项目结构
- **配置文件**：有效和无效的配置示例
- **环境文件**：用于测试优先级的各种 `.env` 配置

## 测试覆盖率要求

### 功能覆盖率目标
- **核心工作流**：90%+ 覆盖率
- **适配器逻辑**：85%+ 覆盖率
- **错误处理**：95%+ 覆盖率
- **配置系统**：90%+ 覆盖率

### 关键测试场景
1. **正常路径**：成功的预览和部署工作流
2. **错误处理**：各种失败场景和恢复
3. **边缘情况**：无效配置、网络问题、权限错误
4. **跨平台**：不同操作系统的行为

## 测试工具

### 测试框架 ✅ 已配置
- **Jest**：主要测试运行器
- **TypeScript 支持**：使用 `ts-jest` 进行类型安全测试
- **异步测试**：Promise 和 async/await 支持

### 测试实用工具
- **临时文件**：用于配置和项目夹具的 `tmp` 目录
- **进程模拟**：`execa` 模拟用于 CLI 调用
- **文件系统模拟**：`fs` 模拟用于文件操作

## 示例测试结构

### 框架适配器测试
```javascript
describe('TaroFrameworkAdapter', () => {
  it('应该检测 Taro 项目', async () => {
    // 测试项目检测逻辑
  });
  
  it('应该成功构建项目', async () => {
    // 测试构建执行
  });
  
  it('应该解析输出路径', async () => {
    // 测试输出目录解析
  });
});
```

### 配置系统测试
```javascript
describe('配置系统', () => {
  it('应该正确合并环境变量', async () => {
    // 测试配置优先级
  });
  
  it('应该验证必需字段', async () => {
    // 测试配置验证
  });
});
```

### 端到端测试
```javascript
describe('CLI 工作流', () => {
  it('应该执行完整的预览工作流', async () => {
    // 测试完整的预览流程
  });
  
  it('应该处理构建失败', async () => {
    // 测试错误处理
  });
});
```

## 性能测试

### 基准测试
- **构建时间**：各种项目大小的构建性能
- **启动时间**：CLI 启动和配置加载时间
- **内存使用**：长时间运行过程的内存配置文件

### 压力测试
- **并发构建**：多个同时构建过程
- **大项目**：具有许多文件和依赖的项目
- **网络超时**：慢网络条件下的行为

## CI/CD 集成

### 自动化测试
```yaml
# GitHub Actions 示例
name: 测试
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: 设置 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: 安装依赖
        run: npm ci
      - name: 运行测试
        run: npm test
      - name: 上传覆盖率报告
        uses: codecov/codecov-action@v3
```

### 跨平台测试
- **Windows**：PowerShell 和 CMD 兼容性
- **macOS**：Unix 路径和权限处理
- **Linux**：各种发行版兼容性

## 测试环境

### 本地开发
```bash
# 运行所有测试
npm test

# 监视模式
npm run test:watch

# 覆盖率报告
npm run test:coverage
```

### 持续集成
- **快速反馈**：关键路径的快速测试套件
- **全面测试**：完整测试套件用于发布
- **夜间测试**：针对真实服务的集成测试

## 测试最佳实践

### 测试隔离
- 每个测试使用独立的临时目录
- 清理所有创建的文件和进程
- 避免测试之间的状态泄漏

### 可维护性
- 清晰的测试命名和描述
- 共享的测试实用工具和夹具
- 定期重构和更新测试

### 文档
- 测试案例文档
- 模拟策略解释
- 故障排除指南

## 测试框架设置 ✅ **已完成**

### 配置文件
- `jest.config.js`：Jest 配置，支持 TypeScript
- `tests/setup.ts`：全局测试设置，包含 i18n 初始化
- `package.json`：测试脚本和 Jest 依赖

### 可用测试命令
```bash
npm test              # 运行所有测试
npm run test:watch    # 监视模式运行测试
npm run test:coverage # 运行测试并生成覆盖率报告
npm run test:ci       # CI/CD 模式运行测试（无监视）
```

### 当前测试状态
- **47 个测试已实现并通过**
- **3 个测试套件**：i18n（16 个测试）、错误处理（14 个测试）、日志器（17 个测试）
- **100% 通过率** 对于已实现的单元测试
- **TypeScript 集成** 工作正常
- **控制台输出模拟** 已配置，确保测试运行清洁

这个测试策略确保 mp-nexus-cli 在所有支持的环境中可靠、健壮地工作，同时为将来的开发和维护提供信心。
