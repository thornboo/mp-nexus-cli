# WeChat Mini Program Private Key Guide

This guide explains how to obtain and configure the private key file required for mp-nexus-cli to work with WeChat Mini Program CI.

## What is the Private Key?

The `private.key` file is a security credential generated by WeChat Mini Program platform that allows:
- Uploading code to WeChat Mini Program backend
- Generating preview QR codes
- Publishing versions automatically
- Calling WeChat Mini Program CI APIs

## 🔍 How to Obtain the Private Key

### Step 1: Access WeChat Mini Program Admin Console
1. Visit https://mp.weixin.qq.com
2. Log in with your mini program administrator account

### Step 2: Navigate to Development Settings
1. Click **「开发」(Development)** → **「开发管理」(Development Management)** in the left sidebar
2. Select the **「开发设置」(Development Settings)** tab

### Step 3: Download Code Upload Key
1. Scroll to the **「代码上传密钥」(Code Upload Key)** section
2. If no key exists, click **「生成」(Generate)** button first
3. Click **「下载密钥」(Download Key)** to save the file
4. Rename the downloaded file to `private.key`
5. Place the key file in your project root directory

## 📁 Recommended File Organization

### Basic Setup
```
your-project/
├── mp-nexus.config.js
├── private.key              # Development key
├── .env
└── .gitignore              # IMPORTANT: Exclude private.key
```

### Multi-Environment Setup (Recommended)
```
your-project/
├── mp-nexus.config.js
├── keys/                    # Dedicated keys folder
│   ├── private-dev.key      # Development environment
│   ├── private-prod.key     # Production environment
│   └── .gitignore           # keys/*
├── .env                     # Development config
├── .env.production          # Production config
└── .gitignore              # Exclude entire keys/ folder
```

## 🔧 Configuration Examples

### Basic Configuration
```javascript
// mp-nexus.config.js
module.exports = {
  appId: 'your_project_appid',
  privateKeyPath: './private.key',  // Path to your key file
  platform: 'weapp',
  // ... other config
};
```

### Environment-Based Configuration
```javascript
// mp-nexus.config.js
module.exports = {
  appId: process.env.MP_APP_ID,
  privateKeyPath: process.env.MP_PRIVATE_KEY_PATH || './private.key',
  platform: 'weapp',
  // ... other config
};
```

### Multi-Environment Setup
```javascript
// mp-nexus.config.js
const env = process.env.NODE_ENV || 'development';
const keyPaths = {
  development: './keys/private-dev.key',
  production: './keys/private-prod.key',
  staging: './keys/private-staging.key'
};

module.exports = {
  appId: process.env.MP_APP_ID,
  privateKeyPath: process.env.MP_PRIVATE_KEY_PATH || keyPaths[env],
  platform: 'weapp',
  // ... other config
};
```

## 🛡️ Security Best Practices

### 1. Never Commit Private Keys to Git
Always add private key files to `.gitignore`:

```bash
# .gitignore
private.key
private-*.key
keys/
*.key
.env.local
.env.*.local
```

### 2. Use Environment Variables in CI/CD
```bash
# .env (for local development)
MP_APP_ID=your_app_id
MP_PRIVATE_KEY_PATH=./keys/private-dev.key

# .env.production
MP_APP_ID=your_production_app_id
MP_PRIVATE_KEY_PATH=./keys/private-prod.key
```

### 3. CI/CD Environment Setup
For GitHub Actions or other CI/CD platforms:

```yaml
# GitHub Actions example
- name: Setup Private Key
  run: |
    mkdir -p keys
    echo "${{ secrets.WECHAT_PRIVATE_KEY }}" > keys/private-prod.key
  env:
    WECHAT_PRIVATE_KEY: ${{ secrets.WECHAT_PRIVATE_KEY }}
```

### 4. File Permissions
Ensure private key files have restricted permissions:
```bash
chmod 600 private.key
chmod 600 keys/*.key
```

## 🔗 Different AppID and Keys

### Multiple Mini Programs
If you manage multiple mini programs, organize keys by project:

```
project-root/
├── keys/
│   ├── app1-dev.key
│   ├── app1-prod.key
│   ├── app2-dev.key
│   └── app2-prod.key
├── configs/
│   ├── app1.config.js
│   └── app2.config.js
└── package.json
```

### Environment-Specific Keys
Different environments may require different AppIDs and keys:

```javascript
// mp-nexus.config.js
const environments = {
  development: {
    appId: 'wxDEV123456789',
    privateKeyPath: './keys/dev.key'
  },
  staging: {
    appId: 'wxSTG123456789', 
    privateKeyPath: './keys/staging.key'
  },
  production: {
    appId: 'wxPROD123456789',
    privateKeyPath: './keys/prod.key'
  }
};

const env = process.env.NODE_ENV || 'development';
const config = environments[env];

module.exports = {
  ...config,
  platform: 'weapp',
  // ... other shared config
};
```

## ❗ Troubleshooting

### Common Issues

**1. "Private key not found"**
- Check if the file path in `privateKeyPath` is correct
- Verify the file exists and is readable
- Check file permissions (should be readable by the user running the CLI)

**2. "Invalid private key format"**
- Re-download the key from WeChat platform
- Ensure the file wasn't corrupted during transfer
- Check the file isn't empty or contains invalid characters

**3. "Authentication failed"**
- Verify the `appId` matches the mini program associated with the private key
- Ensure the private key hasn't expired (WeChat may require key rotation)
- Check if the key was generated for the correct mini program

**4. "Permission denied"**
- Ensure your WeChat account has developer permissions for the mini program
- Verify the mini program is in development or released status
- Check if IP restrictions are configured in WeChat platform

### Debug Commands
```bash
# Test configuration
nexus preview --dry-run --verbose

# Check file permissions
ls -la private.key

# Verify file content (should not be empty)
wc -c private.key
```

## 📚 Additional Resources

- [WeChat Mini Program CI Documentation](https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html)
- [WeChat Developer Platform](https://mp.weixin.qq.com)
- [mp-nexus-cli Configuration Reference](./config-reference.md)
- [Troubleshooting Guide](./troubleshooting.md)

## 🔄 Key Rotation

It's good practice to rotate private keys periodically:

1. Generate a new key in WeChat platform
2. Update your configuration and CI/CD secrets
3. Test with the new key
4. Remove the old key from WeChat platform
5. Clean up old key files securely

Remember to coordinate key rotation across all environments and team members!
