## mp-nexus-cli 开发流程与计划（初稿）

### 一、里程碑规划（M1 → M4）

- M1：MVP 骨架与预览打通（目标 1-2 周）
  - CLI 骨架（命令、参数、帮助、版本显示）。
  - 配置加载与 `.env(.mode)` 支持；优先级策略落地。
  - 框架自动检测（Taro/uni-app），实现 Taro 优先；产物目录解析。
  - `nexus preview` 对接 `miniprogram-ci`，支持终端二维码渲染。
  - 基础日志与错误治理；Windows/macOS/Linux 三端验证。

- M2：部署闭环与错误可观测（目标 1-2 周）
  - `nexus deploy` 上传能力与失败回退提示。
  - Git 集成（commit message 自动作为 desc、package.json version 作为 ver）。
  - 结构化输出（JSON + 人类可读）与错误码分类。
  - 示例仓库与文档初版完善。

- M3：体验增强与初始化（目标 1-2 周）
  - `nexus init` 交互式配置生成器。
  - 多环境覆盖改进（模式化 `.env`）、`--dry-run`、`--verbose`。
  - 通知器（飞书/钉钉/企业微信）可插拔实现。
  - CI（GitHub Actions）集成示例（缓存与并发优化）。

- M4：插件化与多平台（目标 2 周+）
  - 适配器接口稳定，拆分为独立包（framework/platform）。
  - 平台扩展（支付宝/字节）优先一个平台落地，建立兼容矩阵。
  - 覆盖更多框架特性（uni-app/HBuilderX CLI 差异处理）。

---

### 二、任务拆解与优先级

P0（必须）：
- 命令：`preview`、`deploy`；参数：`--mode --desc --ver --config --dry-run --verbose`。
- 配置解析与 ENV 合并；最少可用配置校验（appId、privateKeyPath、platform）。
- Taro 适配器：detect/build/outputPath。
- Weapp 平台适配器：preview/upload（miniprogram-ci）。

P1（重要）：
- 终端二维码（qrcode-terminal）。
- Git 信息自动集成（simple-git）。
- 错误码体系与结构化日志（pino/winston）。

P2（增强）：
- `nexus init` 交互式问答（inquirer/enquirer）。
- 通知器（飞书、钉钉、企业微信）扩展点。
- CI 模版与缓存策略。

---

### 三、开发流程（日常）

1. Issue 驱动：所有需求/缺陷需在 Issue 中描述背景、验收标准、风险与关联 PR。
2. 分支策略：`main/master`（稳定）、`feat/*`（功能）、`fix/*`（修复）、`refactor/*`（重构）。
3. 提交流程：
   - 编码前补充/更新文档与类型声明。
   - 严格 TS 类型、ESLint + Prettier 校验无误。
   - 单元测试通过，必要时加集成测试。
4. 代码评审：至少 1 名 Reviewer；强调易读性与错误处理。
5. 合并策略：Squash & Merge，保证清晰的变更历史。

---

### 四、质量保障

- 静态检查：ESLint、TypeScript 严格模式。
- 单元测试：对配置解析、适配器、CI 调用封装进行覆盖。
- 集成测试：使用示例项目（Taro/uni）跑通 preview/deploy 的伪集成（对 CI 做 mock 或沙箱）。
- 跨平台测试：Windows/macOS/Linux。
- 错误注入：模拟常见失败（鉴权失败、构建失败、路径错误）。

---

### 五、发布与版本策略

- 版本遵循 SemVer：破坏性变更需在 `major` 升级，并在文档中提供迁移指南。
- Release 流程：
  - 变更日志：`changeset` 或手写 `CHANGELOG.md`。
  - CI 检查：lint/test/build 必须通过。
  - 自动发布：GitHub Actions（可选）推送到 npm。

---

### 六、风险清单与对策

- 上游变更：建立依赖版本白名单与兼容矩阵（Taro/uni-app/miniprogram-ci）。
- 环境差异：统一路径与编码；对子进程调用做超时与重试策略。
- 凭证安全：鼓励使用环境变量/CI 密钥注入；日志脱敏；避免将私钥入库。
- 问题定位：分层日志与错误码、`--verbose` 模式提供诊断信息。

---

### 七、资源与依赖

- 主要依赖：`commander|cac`、`execa`、`dotenv`、`simple-git`、`qrcode-terminal`、`miniprogram-ci`、`pino|winston`、`zod|yup`、`tsup|esbuild`。
- 示例项目：准备 Taro 与 uni 的最小化示例用于集成测试与文档演示。

---

### 八、验收标准（DoD）

- `nexus preview`：在示例项目上可一键生成预览二维码（终端渲染 + 文件输出）。
- `nexus deploy`：成功上传一个测试版本，版本号与描述正确透传。
- 配置优先级与多环境合并符合文档描述；`--verbose` 输出完整流程日志。
- Windows/macOS/Linux 三端均可运行；对错误有清晰提示与退出码。


